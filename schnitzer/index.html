
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schnitzer MVP - LogisticApp</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-blue: #0056b3;
            --primary-green: #28a745;
            --primary-yellow: #ffc107;
            --danger-red: #dc3545;
            --bg-light: #f4f7f6;
        }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg-light); touch-action: manipulation; }
        .hidden { display: none !important; }

        /* LOGIN */
        #login-screen { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        .login-field { width: 100%; margin-bottom: 20px; }
        .login-field label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .login-field input, .login-field select { width: 100%; padding: 18px; font-size: 20px; border: 2px solid #ccc; border-radius: 10px; }

        /* DASHBOARD & HEADER */
        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: #eee; border-bottom: 1px solid #ddd; 
        }
        .logout-btn { 
            background: var(--danger-red); border: none; border-radius: 50%; 
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dashboard { padding: 15px; }
        .btn-big { 
            width: 100%; height: 110px; border: none; border-radius: 15px; 
            font-size: 22px; font-weight: bold; color: white; margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-transform: uppercase;
        }
        .blue { background-color: var(--primary-blue); }
        .green { background-color: var(--primary-green); }
        .yellow { background-color: var(--primary-yellow); color: #333; }

        /* INFO BAR */
        .doc-info-bar { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; }

        /* HEADER 50/50 */
        .top-controls { display: flex; width: 100%; background: white; border-bottom: 2px solid #ccc; position: sticky; top: 0; z-index: 100; }
        .top-half { width: 50%; padding: 10px; border-right: 1px solid #eee; }
        .top-half label { font-size: 11px; font-weight: bold; display: block; color: #666; }
        .top-half input, .top-half select { width: 100%; font-size: 16px; padding: 10px 5px; border: 1px solid #aaa; border-radius: 5px; }

        /* LISTA ARTICOLI */
        .page { padding-bottom: 120px; }
        .list-item { background: white; padding: 15px 10px; border-bottom: 2px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .item-header { font-size: 17px; font-weight: bold; color: var(--primary-blue); }
        .input-row { display: flex; gap: 8px; }
        .qty-container { flex: 1; position: relative; }
        .qty-container label { font-size: 10px; color: #777; position: absolute; top: -7px; left: 8px; background: white; padding: 0 3px; z-index: 1; }
        .large-input { width: 100%; padding: 15px 5px; font-size: 20px; font-weight: 800; text-align: right; border: 2px solid #ccc; border-radius: 10px; }

        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.15); z-index: 1000; }
        .btn-action { flex: 1; padding: 20px; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; color: white; }
        .btn-save { background: var(--primary-green); }
        .btn-cancel { background: var(--danger-red); }

        /* ICONA SPEGNIMENTO (CSS) */
        .icon-power::before { content: "‚èª"; }

        /* Stile per la griglia delle zone */
        .zona-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .zona-btn {
            padding: 15px 5px;
            border: 2px solid #ccc;
            border-radius: 10px;
            background: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Colore quando la zona √® selezionata */
        .zona-btn.selected {
            background-color: var(--primary-blue);
            color: white;
            border-color: #003d7a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .list-item {
            transition: background 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpg" alt="Logo" style="width:100px; margin-bottom:20px;" onerror="this.src='https://via.placeholder.com/100'">
        <div class="login-field"><label>UTENTE</label><input type="text" id="user" placeholder="Inserisci nome"></div>
        <div class="login-field"><label>PASSWORD</label>
            <div style="position: relative;">
            <input type="password" id="pass" placeholder="********" 
                style="width:100%; padding:12px; padding-right: 45px;">
            <span id="togglePassword" onclick="togglePasswordVisibility()" 
                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                        cursor: pointer; font-size: 20px; user-select: none;">
                üëÅÔ∏è
            </span>
        </div>
    </div>
    <div class="login-field">
            <label>ZONE</label>
            <div id="zona-grid-container" class="zona-grid"></div>
        </div>
        <button class="btn-big blue" onclick="handleLogin()" style="height:70px;">ENTRA</button>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header-bar">
            <div id="user-display" style="font-weight:bold;"></div>
            <button class="logout-btn" onclick="logout()" title="Esci">
                <span class="icon-power"></span>
            </button>
        </div>
        <div class="dashboard">
            <button class="btn-big blue" onclick="openNewDoc('CARICO')">DOCUMENTO CARICO</button>
            <button class="btn-big green" onclick="openNewDoc('DDT')">DDT (VENDITA)</button>
            <button class="btn-big yellow" onclick="showPage('page-modifica')">STAMPA / INVIO</button>
        </div>
    </div>

    <div id="page-editor" class="page hidden">
        <div id="editing-info" class="doc-info-bar">NUOVO DOCUMENTO</div>
        
        <div class="top-controls">
            <div class="top-half"><label>DATA</label><input type="date" id="doc-date-input"></div>
            <div class="top-half"><label>TARGA</label><select id="targa-select"></select></div>
        </div>

        <div id="cliente-area" class="cliente-box hidden">
            <label>CLIENTE (Cerca per nome o codice)</label>
            <div style="position: relative;">
                <input type="text" id="cliente-search" placeholder="Inizia a scrivere il nome..." 
                    oninput="cercaClienteLive()" autocomplete="off"
                    style="width:100%; padding:15px; font-size:18px; border:2px solid var(--primary-green); border-radius:10px;">
                <span onclick="resetCliente()" id="btn-reset-cliente" 
                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 25px; color: #999; cursor: pointer; display:none;">&times;</span>
            </div>
            <div id="clienti-suggeriti" style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ccc; border-radius: 0 0 10px 10px; display: none;"></div>
            
            <input type="hidden" id="selected-cliente-id">
        </div>

        <div style="padding:10px;position: relative;">
            <input type="text" id="art-search" placeholder="üîç Cerca articolo..." onkeyup="filterArticoli()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;">
            <span onclick="clearSearch()" style="position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #999; cursor: pointer; padding: 5px;">&times;</span>
        </div>
        
        <div id="articoli-list"></div>

        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')">ANNULLA</button>
            <button class="btn-action btn-save" onclick="salvaInLocale()">SALVA</button>
        </div>
    </div>

    <div id="page-modifica" class="page hidden">
        <div id="bulk-upload-container" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; margin-bottom: 15px;">
            <button onclick="inviaTuttiISospesi()" id="btn-invia-tutti" 
                    style="width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; display: none;">
                üì§ INVIA TUTTI I SOSPESI (<span id="count-sospesi">0</span>)
            </button>
        </div>
        <div style="padding: 15px;">
            <h3 style="margin-top:0">Documenti in attesa</h3>
            <div id="lista-ddt-attesa"></div>
        </div>
        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')" style="width:100%">TORNA INDIETRO</button>
        </div>
    </div>

<script>
    // --- STATO DELL'APPLICAZIONE ---
    let anagraficaArticoli = []; 
    let anagraficheClienti = [];
    let targhe = [];
    let ddtSalvati = JSON.parse(localStorage.getItem('ddt_local') || '[]');
    let currentEditingId = null;
    let currentType = '';
    let zoneSelezionate = [];
    let listaUtentiAutorizzati = [];

    // --- CARICAMENTO INIZIALE ---
    window.onload = async () => {
        popolaZone();
        await caricaDatiBase();
        renderTarghe();
    };

    function togglePasswordVisibility() {
        const passInput = document.getElementById('pass');
        const toggleIcon = document.getElementById('togglePassword');
        
        if (passInput.type === "password") {
            passInput.type = "text";
            toggleIcon.innerText = "üîí"; // Icona lucchetto quando √® visibile
        } else {
            passInput.type = "password";
            toggleIcon.innerText = "üëÅÔ∏è"; // Icona occhio quando √® nascosta
        }
    }

    // Aggiungi questo all'interno di window.onload o come funzione globale
    document.addEventListener('DOMContentLoaded', () => {
        const loginFields = ['user', 'pass'];
        
        loginFields.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });
    });

    function ottieniPrezzoPerCliente(infoArt) {
        const idCli = document.getElementById('selected-cliente-id').value;
        const cliente = anagraficaClienti.find(c => c.id === idCli);
        const listino = cliente ? cliente.listino : "";

        // Logica di selezione basata sul listino (01, 02, 03)
        let prezzoScelto = "";
        if (listino === '01') prezzoScelto = infoArt.prezzo1;
        else if (listino === '02') prezzoScelto = infoArt.prezzo2;
        else if (listino === '03') prezzoScelto = infoArt.prezzo3;

        return prezzoScelto;
    }
    
    async function caricaDatiBase() {
        try {
            // Caricamento Articoli
            const resArt = await fetch('ANAPC00F_20260112 prodotti - Copia.csv');
            const textArt = await resArt.text();
            anagraficaArticoli = textArt.split('\n').slice(2).filter(r => r.includes('|')).map(row => {
                const c = row.split('|'); 
                return { id: c[0].trim(), 
                         um: c[1].trim(), 
                         nome: c[3].trim(), 
                         prezzo1: c[6] ? c[6].replace(',', '.') : "",
                         prezzo2: c[7] ? c[7].replace(',', '.') : "",
                         prezzo3: c[8] ? c[8].replace(',', '.') : ""
                    };
            });
            // Caricamento Targhe
            const resTar = await fetch('targhe.csv');
            targhe = (await resTar.text()).split('\n').map(t => t.trim()).filter(t => t);
            
            const resUtenti = await fetch('user.csv');
            if (resUtenti.ok) {
                const textUtenti = await resUtenti.text();
                listaUtentiAutorizzati = textUtenti.split('\n').filter(r => r.includes('|')).map(row => {
                    const c = row.split('|');
                    return { 
                        user: c[0].trim().toUpperCase(), 
                        pass: c[1].trim(), 
                        nome: c[2]?.trim() || c[0].trim(),
                    };
                });
            }
        } catch (e) { console.error("Errore caricamento file base:", e); }
    }

    // --- GESTIONE LOGIN E ZONE ---
    function popolaZone() {
        const container = document.getElementById('zona-grid-container');
        const zoneList = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '22'];
        container.innerHTML = zoneList.map(z => `<div class="zona-btn" id="btn-zona-${z}" onclick="toggleZona('${z}')">${z}</div>`).join('');        
    }

    function toggleZona(z) {
        const btn = document.getElementById(`btn-zona-${z}`);
        const idx = zoneSelezionate.indexOf(z);
        if (idx > -1) { zoneSelezionate.splice(idx, 1); btn.classList.remove('selected'); }
        else { zoneSelezionate.push(z); btn.classList.add('selected'); }
    }

    async function handleLogin() {
        if (event) event.preventDefault();
        const uInput = document.getElementById('user').value.trim().toUpperCase();
        const pInput = document.getElementById('pass')?.value; // Assicurati di avere un id="pass" nell'HTML
        
        if (zoneSelezionate.length === 0) {
            return alert("Seleziona almeno una zona prima di accedere.");
        }

        // Ricerca dell'utente nella lista caricata dal CSV
        const utenteTrovato = listaUtentiAutorizzati.find(u => u.user === uInput && u.pass === pInput);

        if (!utenteTrovato) {
            return alert("Credenziali non valide. Riprova.");
        }

        // Se arriviamo qui, il login √® corretto
        await caricaAnagraficheZone(zoneSelezionate);
        
        // Usiamo il nome completo dell'utente se disponibile
        document.getElementById('user-display').innerText = 
            `OPERATORE: ${utenteTrovato.nome} | ZONE: ${zoneSelezionate.sort().join(', ')}`;
        
        showPage('dashboard');
    }

    async function caricaAnagraficheZone(zoneArray) {
        anagraficheClienti = [];
        for (const zona of zoneArray) {
            try {
                const res = await fetch(`anagrafiche_${zona}.csv`);
                if (!res.ok) continue;
                const text = await res.text();
                const nuovi = text.split('\n').slice(1).filter(r => r.includes('|')).map(row => {
                    const c = row.split('|');
                    return { id: c[0].trim(), 
                             nome: c[3].trim(), 
                             zona: c[2].trim(), 
                             rg2: c[4]?.trim() || "" , 
                             localita: c[6]?.trim() || "" ,
                             listino: c[11]?.trim() || ""};
                });
                anagraficheClienti = anagraficheClienti.concat(nuovi);
            } catch (e) { console.error(`Errore zona ${zona}`, e); }
        }
    }

    // --- LOGICA CORE: RENDERING E FILTRI ---
    
    // Funzione UNICA per creare l'HTML di una riga articolo
    function creaRigaArticolo(art, qtaVal = 0, colliVal = 0, przVal = 0) {
        const qFmt = parseFloat(qtaVal || 0).toFixed(3);
        const pFmt = parseFloat(przVal || 0).toFixed(2);
        return `
            <div class="list-item" data-id="${art.id}" data-nome="${art.nome}">
                <div class="item-header"><strong>${art.id}</strong> ${art.nome}</div>
                <div class="input-row">
                    ${currentType === 'CARICO' ? `
                        <div class="qty-container"><label>COLLI</label><input type="number" class="large-input colli-in" value="${colliVal}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                        <div class="qty-container"><label>QUANTIT√Ä</label><input type="number" step="0.001" class="large-input qta-in" value="${qFmt}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                    ` : `
                        <div class="qty-container"><label>QUANTIT√Ä</label><input type="number" step="0.001" class="large-input qta-in" value="${qFmt}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                        <div class="qty-container"><label>PREZZO ‚Ç¨</label><input type="number" step="0.01" class="large-input prz-in" value="${pFmt}" onfocus="this.select()"></div>
                    `}
                </div>
                <span class="error-msg" style="color:red; font-size:11px; font-weight:bold; display:block; margin-top:5px; height:15px;"></span>
            </div>`;
    }

    function renderArticoli(lista = anagraficaArticoli, isModifica = false) {
        const container = document.getElementById('articoli-list');
        if (!container) return;
        // In modifica mostriamo solo gli articoli passati, in nuovo documento usiamo la ricerca
        container.innerHTML = lista.map(art => {
            if(isModifica) return creaRigaArticolo(art, art.qta, art.colli, art.prezzo);
            return creaRigaArticolo(art, 0, 0, art.prezzoBase || 0);
        }).join('');
    }

    function filterArticoli() {
        const q = document.getElementById('art-search').value.toLowerCase();
        const container = document.getElementById('articoli-list');
        
        // 1. Gestione visibilit√† articoli gi√† presenti nel DOM
        let trovatiNelDom = false;
        document.querySelectorAll('#articoli-list .list-item').forEach(item => {
            const match = item.dataset.nome.toLowerCase().includes(q) || item.dataset.id.toLowerCase().includes(q);
            item.style.display = match ? 'flex' : 'none';
            if (match) trovatiNelDom = true;
        });

        // 2. Se stiamo cercando (almeno 2 caratteri) e non c'√® match nel DOM, cerchiamo in anagrafica
        if (q.length >= 2 && !trovatiNelDom) {
            const nuoviMatch = anagraficaArticoli.filter(a => 
                a.nome.toLowerCase().includes(q) || a.id.toLowerCase().includes(q)
            ).slice(0, 5); // Limitiamo a 5 risultati per performance

            nuoviMatch.forEach(art => {
                const listinoAttuale = document.getElementById('selected-cliente-id').dataset.listino || "";
                let prezzoIniziale = 0; // Default nullo se non c'√® listino

                if (listinoAttuale === '01') prezzoIniziale = art.prezzo1;
                else if (listinoAttuale === '02') prezzoIniziale = art.prezzo2;
                else if (listinoAttuale === '03') prezzoIniziale = art.prezzo3;

                const nuovaRiga = creaRigaArticolo(art, 0, 0, prezzoIniziale);
                container.insertAdjacentHTML('beforeend', nuovaRiga);
                
                // Controlliamo che non sia gi√† stato aggiunto (per evitare duplicati)
                if (!document.querySelector(`#articoli-list .list-item[data-id="${art.id}"]`)) {
                    const nuovaRiga = creaRigaArticolo(art, 0, 0, art.prezzoBase || 0);
                    container.insertAdjacentHTML('beforeend', nuovaRiga);
                }
            });
        }
    }

    // --- GESTIONE DOCUMENTI ---
    function openNewDoc(type) {
        currentType = type;
        currentEditingId = null;
        document.getElementById('editing-info').innerText = "NUOVO: " + type;
        document.getElementById('doc-date-input').valueAsDate = new Date();
        
        document.getElementById('cliente-area').classList.toggle('hidden', type !== 'DDT');
        
        // Pulizia campi ricerca
        document.getElementById('art-search').value = '';
        resetCliente();
        
        showPage('page-editor');
        renderArticoli(); // Mostra l'intera anagrafica
    }

    function puliziaDocumentiVecchi() {
        const OGGI = new Date();
        const LIMITE_GIORNI = 3;
        let contatoreVecchi = 0;

        // Filtriamo i documenti
        const documentiFiltrati = ddtSalvati.filter(doc => {
            const dataDoc = new Date(doc.data);
            // Calcolo differenza in millisecondi e conversione in giorni
            const diffTempo = OGGI - dataDoc;
            const diffGiorni = diffTempo / (1000 * 60 * 60 * 24);

            if (diffGiorni > LIMITE_GIORNI) {
                contatoreVecchi++;
                return false; // Elimina il documento
            }
            return true; // Mantieni il documento
        });

        if (contatoreVecchi > 0) {
            // AVVISO TEMPORANEO (da togliere in produzione)
            alert(`‚ö†Ô∏è AVVISO DEBUG: Rilevati ${contatoreVecchi} documenti vecchi (pi√π di 3 giorni). Saranno eliminati.`);

            // Aggiorniamo lo stato e il localStorage
            ddtSalvati = documentiFiltrati;
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        }
    }

    function caricaPerModifica(id) {
        const doc = ddtSalvati.find(d => d.id === id);
        if (!doc) return;

        // MODIFICA: Il blocco scatta SOLO per i DDT stampati.
        // Se √® un CARICO, il controllo viene saltato e la modifica procede.
        if (doc.tipo === 'DDT' && doc.stampato) {
            alert("ATTENZIONE: Questo DDT √® gi√† stato stampato e non pu√≤ pi√π essere modificato.");
            return;
        }

        // Impostiamo le variabili di stato per l'editor
        currentEditingId = doc.id;
        currentType = doc.tipo;
        
        // Pulizia e apertura pagina
        document.getElementById('art-search').value = '';
        showPage('page-editor');
        
        // Aggiorniamo il titolo nell'editor per dare un feedback
        const infoTitolo = document.getElementById('editing-info');
        if (infoTitolo) {
            infoTitolo.innerText = doc.stampato ? 
                `RETTIFICA ${doc.tipo}: ${doc.id}` : 
                `MODIFICA ${doc.tipo}: ${doc.id}`;
        }

        // Caricamento dati cliente (solo se DDT)
        const inputVisuale = document.getElementById('cliente-search');
        const inputNascosto = document.getElementById('selected-cliente-id');
        const btnReset = document.getElementById('btn-reset-cliente');

        if (doc.tipo === 'DDT') {
            inputVisuale.value = `${doc.clienteId} - ${doc.clienteNome}`;
            inputVisuale.disabled = true; // Impedisce di cambiare cliente su un DDT esistente
            inputNascosto.value = doc.clienteId;
            const clienteAnag = anagraficheClienti.find(c => c.id === doc.clienteId);
            inputNascosto.dataset.listino = clienteAnag ? clienteAnag.listino : "";
            if (btnReset) btnReset.style.display = 'block';
        } else {
            // Se √® un carico, svuotiamo i campi cliente (non servono)
            inputVisuale.value = "MAGAZZINO";
            inputVisuale.disabled = true;
            inputNascosto.value = "MAGAZZINO";
            if (btnReset) btnReset.style.display = 'none';
        }

        // Carica gli articoli nel modulo
        renderArticoli(doc.items, true);
    }

    function salvaInLocale() {
        const idCli = document.getElementById('selected-cliente-id').value;
        if (currentType === 'DDT' && !idCli) return alert("Seleziona un cliente!");

        const items = [];
        let valid = true;

        document.querySelectorAll('#articoli-list .list-item').forEach(el => {
            const qta = parseFloat(el.querySelector('.qta-in')?.value) || 0;
            const colli = parseInt(el.querySelector('.colli-in')?.value) || 0;
            const prz = parseFloat(el.querySelector('.prz-in')?.value) || 0;
            const errorSpan = el.querySelector('.error-msg');

            if (currentType === 'CARICO' && ((qta > 0 && colli <= 0) || (colli > 0 && qta <= 0))) {
                el.style.background = "#ffe6e6";
                if(errorSpan) errorSpan.innerText = "‚ö†Ô∏è Inserire Qta e Colli";
                valid = false;
            }

            if (qta > 0 || colli > 0) {
                items.push({ id: el.dataset.id, nome: el.dataset.nome, qta, colli, prezzo: prz });
            }
        });

        if (!valid) return;
        if (items.length === 0) return alert("Inserisci almeno un articolo!");

        // Se √® un nuovo documento, creiamo un ID temporaneo 'TEMP-timestamp'
        // Se √® una modifica, manteniamo l'ID che ha gi√†
        const newId = currentEditingId || `TEMP-${Date.now()}`;
        
        const doc = {
            id: newId,
            tipo: currentType,
            data: document.getElementById('doc-date-input').value,
            targa: document.getElementById('targa-select').value,
            clienteId: idCli || 'MAGAZZINO',
            clienteNome: currentType === 'DDT' ? document.getElementById('cliente-search').value.split(' - ')[1] : 'CARICO',
            zona: document.getElementById('selected-cliente-id').dataset.zona || '',
            items: items,
            stampato: false,
            numeroProgressivo: null
        };

        const idx = ddtSalvati.findIndex(d => d.id === doc.id);
        if(idx > -1) ddtSalvati[idx] = doc; else ddtSalvati.push(doc);
        
        localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        localStorage.setItem('ultima_targa', doc.targa);
        showPage('dashboard');
    }

    function generaID(tipoDoc) {
        // Recuperiamo l'utente e prendiamo le prime 2 lettere
        const uInput = document.getElementById('user').value.trim();
        const u = uInput.substring(0, 2).toUpperCase() || "XX";
        
        const annoCorrente = new Date().getFullYear();
        const ultimoAnno = localStorage.getItem('ultimo_anno_prog');

        // Reset annuale dei contatori
        if (ultimoAnno !== annoCorrente.toString()) {
            localStorage.setItem('prog_ddt', '0');
            localStorage.setItem('prog_carico', '0');
            localStorage.setItem('ultimo_anno_prog', annoCorrente.toString());
        }

        let progressivo = 0;
        let idFinale = "";

        // Forza il confronto in maiuscolo per evitare errori di battitura
        if (tipoDoc.toUpperCase() === 'DDT') {
            progressivo = parseInt(localStorage.getItem('prog_ddt') || '0') + 1;
            localStorage.setItem('prog_ddt', progressivo);
            // Esempio: MA/00001
            idFinale = u + "/" + progressivo.toString().padStart(5, '0');
        } else {
            // Entra qui solo se √® CARICO o qualsiasi altra cosa
            progressivo = parseInt(localStorage.getItem('prog_carico') || '0') + 1;
            localStorage.setItem('prog_carico', progressivo);
            // Esempio: MA/00001/MAGAZZINO
            idFinale = u + "/" + progressivo.toString().padStart(5, '0') + "/MAGAZZINO";
        }

        console.log("Generato ID tipo:", tipoDoc, " -> ", idFinale); // Per debug in console
        return idFinale;
    }

    // --- INTERFACCIA UTENTE ---
    function showPage(id) {
        document.querySelectorAll('.page, #login-screen, #dashboard').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        // Trigger pulizia: Solo se entriamo nell'editor per un NUOVO CARICO
        if (id === 'page-editor' && currentType === 'CARICO' && currentEditingId === null) {
            puliziaDocumentiVecchi();
        }

        // Se stiamo entrando nell'editor, puliamo la barra di ricerca articoli
        if (id === 'page-editor') {
            const artSearch = document.getElementById('art-search');
            if (artSearch) artSearch.value = ''; 
            // Non chiamiamo filterArticoli qui perch√© l'elenco viene gi√† gestito da openNewDoc o caricaPerModifica
        }
        
        if (id === 'page-modifica') renderListaModifica();
    }

    async function forzaInvio(id) {
        const doc = ddtSalvati.find(d => d.id === id);
        if (!doc) return;

        const successo = await inviaSingoloDocumento(doc);
        if (successo) {
            doc.inviato = true;
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
            alert("‚úÖ Invio riuscito!");
            renderListaModifica();
        } else {
            alert("‚ùå Errore: il server non risponde. Controlla la connessione.");
        }
    }

    function renderListaModifica() {
        const container = document.getElementById('lista-ddt-attesa');
        const btnTutti = document.getElementById('btn-invia-tutti');
        const countSpan = document.getElementById('count-sospesi');
        if (!container) return;

        // Conta quanti documenti sono sospesi
        const sospesi = ddtSalvati.filter(d => d.stampato && !d.inviato && d.tipo === 'DDT');    
        
        if (btnTutti) {
            if (sospesi.length > 0) {
                btnTutti.style.display = "block";
                countSpan.innerText = sospesi.length;
            } else {
                btnTutti.style.display = "none";
            }
        }
        // Invertiamo l'ordine: gli ultimi inseriti appariranno per primi
        const documentiOrdinati = ddtSalvati.slice().reverse();

        container.innerHTML = documentiOrdinati.map(d => {
            const dataFmt = d.data.split('-').reverse().join('/');

            // Calcoliamo il totale solo se TUTTI gli articoli hanno un prezzo > 0
            const haPrezzi = d.items.every(i => i.prezzo > 0);
            const sommaTotale = d.items.reduce((acc, i) => acc + (i.qta * i.prezzo), 0);
            
            // Prepariamo la stringa del totale: se non ha prezzi, la stringa rimane vuota
            const stringaTotale = (haPrezzi && sommaTotale > 0) 
                ? `| <strong>Tot: ‚Ç¨ ${sommaTotale.toFixed(2)}</strong>` 
                : '';
                
            // Stile condizionale: grigio se stampato, verde se modificabile
            const borderCol = d.stampato ? '#6c757d' : 'var(--primary-green)';
            const opacity = d.stampato ? '0.7' : '1';

            // Un doc di carico stampato permette ancora la modifica
            const puoModificare = !d.stampato || d.tipo === 'CARICO';

            const displayID = d.numeroProgressivo || `<span style="color:orange">PROVVISORIO</span>`;

            // --- LOGICA STATO INVIO ---
            let badgeInvio = "";
            let bottoneInvioManuale = "";

            if (d.tipo === 'DDT' && d.stampato) {
                if (d.inviato) {
                    badgeInvio = `<span style="color: #28a745; font-size: 0.85em; font-weight: bold;">‚óè INVIATO</span>`;
                } else {
                    badgeInvio = `<span style="color: #dc3545; font-size: 0.85em; font-weight: bold;">‚óè NON INVIATO</span>`;
                    // Pulsante di invio manuale (Blu)
                    bottoneInvioManuale = `
                        <button onclick="forzaInvio('${d.id}')" 
                                style="width: 100%; margin-top: 10px; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>üì§</span> INVIA AL SERVER
                        </button>`;
                }
            }

            return `
                <div class="list-item" style="border-left:8px solid ${borderCol}; margin-bottom:10px; opacity: ${opacity}">
                    <div style="display:flex; justify-content:space-between">
                        <strong>${displayID}</strong> 
                        <span style="margin-left:10px; font-size: 0.9em; color: #444;">üìÖ ${dataFmt}</span>
                        <span>${d.tipo} ${d.stampato ? '‚úÖ STAMPATO' : 'üìù BOZZA'}</span>
                    </div>
                    <div>Cod. ${d.clienteId} - <strong>${d.clienteNome}</strong></div>
                    <div style="font-size:12px">Articoli: ${d.items.length} ${stringaTotale ? `| <strong>Tot: ‚Ç¨ ${sommaTotale}</strong>` : ''}</div>
                    
                    <div style="display:flex; gap:10px; margin-top:10px">
                    ${puoModificare ? `
                        <button onclick="caricaPerModifica('${d.id}')" style="flex:1; padding:10px; border-radius:5px; border:1px solid #ccc; background: white;">MODIFICA</button>
                    ` : `
                        <button disabled style="flex:1; padding:10px; background:#eee; color:#999; border:1px solid #ccc; border-radius:5px;">BLOCCATO</button>
                    `}
                    <button onclick="stampaEInvia('${d.id}')" style="flex:1; padding:10px; background:var(--primary-yellow); border:none; border-radius:5px; font-weight:bold;">
                        ${d.stampato ? 'RISTAMPA' : 'STAMPA'}
                    </button>
                </div>
            ${bottoneInvioManuale}
            </div>`;
        }).join('');
    }

    function cercaClienteLive() {
        const q = document.getElementById('cliente-search').value.toLowerCase();
        const sug = document.getElementById('clienti-suggeriti');
        if (q.length < 2) return sug.style.display = 'none';

        const matches = anagraficheClienti.filter(a => a.nome.toLowerCase().includes(q) || a.id.includes(q)).slice(0, 10);
        sug.innerHTML = matches.map(a => `
            <div onclick="selezionaCliente('${a.id}', '${a.nome.replace(/'/g, "\\'")}', '${a.zona}')" style="padding:15px; border-bottom:1px solid #eee;">
                <strong>${a.id}</strong> - ${a.nome} <br><small>${a.rg2} - ${a.localita}</small>
            </div>`).join('');
        sug.style.display = matches.length ? 'block' : 'none';
    }

    function selezionaCliente(id, nome, zona) {
        const v = document.getElementById('cliente-search');
        const n = document.getElementById('selected-cliente-id');
        const cliente = anagraficheClienti.find(c => c.id === id); // Trova oggetto completo
        const listino = (cliente && cliente.listino && cliente.listino.trim() !== "") ? cliente.listino : null;

        v.value = `${id} - ${nome}`; v.disabled = true;
        n.value = id; 
        n.dataset.zona = zona;
        n.dataset.listino = listino || ""; // Salva il listino o null nel dataset
        document.getElementById('clienti-suggeriti').style.display = 'none';
        document.getElementById('btn-reset-cliente').style.display = 'block';
        aggiornaPrezziListino(cliente.listino);
    }

    function aggiornaPrezziListino(codiceListino) {
        // Seleziona tutte le righe articoli nel DOM
        const righe = document.querySelectorAll('#articoli-list .list-item');
        
        righe.forEach(riga => {
            const artId = riga.dataset.id;
            const infoArt = anagraficaArticoli.find(a => a.id === artId);
            
            if (infoArt) {
                let prezzoScelto = 0;
                console.log(`Aggiornamento prezzo per articolo ${artId} con listino ${codiceListino}`); // Debug
                // Logica di selezione basata sul listino
                if (codiceListino === '01') prezzoScelto = infoArt.prezzo1;
                else if (codiceListino === '02') prezzoScelto = infoArt.prezzo2;
                else if (codiceListino === '03') prezzoScelto = infoArt.prezzo3;

                const inputPrezzo = riga.querySelector('.prz-in');
                if (inputPrezzo) {
                    inputPrezzo.value = parseFloat(prezzoScelto || 0).toFixed(2);
                    inputPrezzo.disabled = !prezzoScelto;
                    // Feedback visivo: evidenzia brevemente il cambio prezzo
                    inputPrezzo.style.backgroundColor = "#e8f0fe";
                    setTimeout(() => inputPrezzo.style.backgroundColor = "white", 500);
                }
            }
        });
    }
    function resetCliente() {
        const v = document.getElementById('cliente-search');
        v.value = ''; v.disabled = false;
        document.getElementById('selected-cliente-id').value = '';
        document.getElementById('btn-reset-cliente').style.display = 'none';
    }

    function pulisciErrore(el) {
        const r = el.closest('.list-item');
        r.style.background = "white";
        const m = r.querySelector('.error-msg');
        if(m) m.innerText = "";
    }

    function clearSearch() { document.getElementById('art-search').value = ''; filterArticoli(); }
    function renderTarghe() {
        const s = document.getElementById('targa-select');
        s.innerHTML = targhe.map(t => `<option value="${t}">${t}</option>`).join('');
        if(localStorage.getItem('ultima_targa')) s.value = localStorage.getItem('ultima_targa');
    }

    function mostraNotificaInviato() {
        const div = document.createElement('div');
        div.innerText = "Documento sincronizzato con successo!";
        div.style = "position:fixed; top:20px; right:20px; background:green; color:white; padding:15px; border-radius:8px; z-index:9999;";
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
    async function stampaEInvia(id) {

        // Cerchiamo il documento nell'array
        const doc = ddtSalvati.find(d => d.id === id);
        if (!doc) return;

        // Se non ha ancora un numero progressivo (prima stampa), lo generiamo ora
        if (!doc.numeroProgressivo) {
            // Usiamo esplicitamente doc.tipo che abbiamo salvato nella funzione salvaInLocale
            const nuovoID = generaID(doc.tipo); 
            doc.numeroProgressivo = nuovoID;
            doc.id = nuovoID; // Aggiorniamo l'id per non avere pi√π il TEMP-
        }
        // Simulazione invio stampa
        alert(`Documento ${doc.numeroProgressivo} inviato alla stampa!\nDa questo momento non sar√† pi√π modificabile.`);

        // Segniamo il documento come stampato
        doc.stampato = true;

        // TENTATIVO DI INVIO: Solo se √® un DDT
        if (doc.tipo === 'DDT') {
            const esito = await inviaSingoloDocumento(doc);
            if (esito) {
                doc.inviato = true;
                mostraNotificaInviato(); 
            } else {
                doc.inviato = false;
                alert("‚ö†Ô∏è Documento stampato ma NON inviato al server. Potrai riprovare dalla lista.");
            }
        } else {
            // Se √® un CARICO, lo segniamo come "non applicabile" o non inviato per coerenza
            doc.inviato = false; 
        }
             
        // Salviamo lo stato aggiornato
        localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        
        // Torniamo alla dashboard o rinfreschiamo la lista
        renderListaModifica();
    }
    
    // Formatta Data in AAAAMMGG
    function formatDataCSV(dataISO) {
        return dataISO.replace(/-/g, '');
    }

    // Formatta Ora in HHMMSS
    function formatOraCSV() {
        const ora = new Date();
        return ora.getHours().toString().padStart(2, '0') +
            ora.getMinutes().toString().padStart(2, '0') +
            ora.getSeconds().toString().padStart(2, '0');
    }

    // Formatta i numeri con virgola e decimali fissi (es: 0,50000)
    function formatNumCSV(num, decimali) {
        return parseFloat(num).toFixed(decimali).replace('.', ',');
    }

    async function inviaTuttiISospesi() {
        // Filtriamo i documenti stampati ma NON inviati
        const sospesi = ddtSalvati.filter(d => d.stampato && !d.inviato && d.tipo === 'DDT');        
        
        if (sospesi.length === 0) return;

        const btn = document.getElementById('btn-invia-tutti');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.style.backgroundColor = "#6c757d";
        btn.innerText = "Sincronizzazione in corso...";

        let inviatiConSuccesso = 0;

        for (const doc of sospesi) {
            const successo = await inviaSingoloDocumento(doc);
            if (successo) {
                doc.inviato = true;
                inviatiConSuccesso++;
            }
            // Aggiorniamo il localStorage dopo ogni singolo invio per sicurezza
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        }

        // Feedback finale
        alert(`Sincronizzazione completata: ${inviatiConSuccesso} documenti inviati.`);
        
        // Ripristiniamo l'interfaccia
        btn.disabled = false;
        btn.style.backgroundColor = "#28a745";
        btn.innerHTML = originalText;
        
        renderListaModifica(); // Ricarica la lista per aggiornare i badge
    }

    function preparaCSVPerDocumentoSingolo(doc) {
        if (!doc || !doc.numeroProgressivo) {
            console.error("Documento non valido o non ancora numerato.");
            return null;
        }

        // --- LOGICA DI DIVISIONE ID (Serie e Numero) ---
        // Gestisce formati come "MA/00001" o "MA/00001/MAGAZZINO"
        const partiID = doc.numeroProgressivo.split('/');
        const serie = partiID[0];      // Es: "MA"
        const numeroDoc = partiID[1];   // Es: "00001"
        
        const dataFmt = formatDataCSV(doc.data);
        const oraFmt = formatOraCSV();
        const codiceCli = doc.clienteId; 

        // --- GENERAZIONE TESTATINA ---
        // Tracciato: T | OC | SERIE | NUMERO | DEST1 | DEST2 | DATA | ORA
        const csvTestatina = `T|OC|${serie}|${numeroDoc}|${codiceCli}|${codiceCli}|${dataFmt}|${oraFmt}\n`;

        // --- GENERAZIONE ARTICOLI ---
        // Tracciato: R | OC | DATA | SERIE | NUMERO | CODART | QTA | PREZZO | 0 | UM |
        let csvArticoli = "";
        doc.items.forEach(item => {
            const infoArt = anagraficaArticoli.find(a => a.id === item.id);
            const um = infoArt ? infoArt.um : 'KG';

            const riga = [
                "R",
                "OC",
                dataFmt,
                serie,      // 4¬∞ campo
                numeroDoc,  // 5¬∞ campo
                item.id,
                formatNumCSV(item.qta, 5),
                formatNumCSV(item.prezzo, 5),
                "0,00",     // Penultimo campo fisso
                um          // Ultimo campo prima del pipe finale
            ];
            
            csvArticoli += riga.join('|') + "|\n";
        });

        return {
            testatina: csvTestatina,
            articoli: csvArticoli
        };
    }

    async function inviaSingoloDocumento(doc) {
        // Usiamo la logica di preparazione file adattata al singolo documento
        const csvData = preparaCSVPerDocumentoSingolo(doc);
        if (!csvData) return false;

        const formData = new FormData();
        formData.append('testatina', new Blob([csvData.testatina], { type: 'text/csv' }), 'testatina.csv');
        formData.append('articoli', new Blob([csvData.articoli], { type: 'text/csv' }), 'articoli.csv');

        console.log("Invio documento:", csvData);
        try {
            const response = await fetch('upload.php', {
                method: 'POST',
                body: formData
            });
            return response.ok;
        } catch (error) {
            console.error("Errore invio:", error);
            return false;
        }
    }

    function logout() { if(confirm("Tornare al login?")) showPage('login-screen'); }

</script>
</body>
</html>