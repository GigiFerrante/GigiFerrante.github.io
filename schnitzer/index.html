
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schnitzer MVP - LogisticApp</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-blue: #0056b3;
            --primary-green: #28a745;
            --primary-yellow: #ffc107;
            --danger-red: #dc3545;
            --bg-light: #f4f7f6;
        }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg-light); touch-action: manipulation; }
        .hidden { display: none !important; }

        /* LOGIN */
        #login-screen { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        .login-field { width: 100%; margin-bottom: 20px; }
        .login-field label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .login-field input, .login-field select { width: 100%; padding: 18px; font-size: 20px; border: 2px solid #ccc; border-radius: 10px; }

        /* DASHBOARD & HEADER */
        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: #eee; border-bottom: 1px solid #ddd; 
        }
        .logout-btn { 
            background: var(--danger-red); border: none; border-radius: 50%; 
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dashboard { padding: 15px; }
        .btn-big { 
            width: 100%; height: 110px; border: none; border-radius: 15px; 
            font-size: 22px; font-weight: bold; color: white; margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-transform: uppercase;
        }
        .blue { background-color: var(--primary-blue); }
        .green { background-color: var(--primary-green); }
        .yellow { background-color: var(--primary-yellow); color: #333; }

        /* INFO BAR */
        .doc-info-bar { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; }

        /* HEADER 50/50 */
        .top-controls { display: flex; width: 100%; background: white; border-bottom: 2px solid #ccc; position: sticky; top: 0; z-index: 100; }
        .top-half { width: 50%; padding: 10px; border-right: 1px solid #eee; }
        .top-half label { font-size: 11px; font-weight: bold; display: block; color: #666; }
        .top-half input, .top-half select { width: 100%; font-size: 16px; padding: 10px 5px; border: 1px solid #aaa; border-radius: 5px; }

        /* LISTA ARTICOLI */
        .page { padding-bottom: 120px; }
        .list-item { background: white; padding: 15px 10px; border-bottom: 2px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .item-header { font-size: 17px; font-weight: bold; color: var(--primary-blue); }
        .input-row { display: flex; gap: 8px; }
        .qty-container { flex: 1; position: relative; }
        .qty-container label { font-size: 10px; color: #777; position: absolute; top: -7px; left: 8px; background: white; padding: 0 3px; z-index: 1; }
        .large-input { width: 100%; padding: 15px 5px; font-size: 20px; font-weight: 800; text-align: right; border: 2px solid #ccc; border-radius: 10px; }

        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.15); z-index: 1000; }
        .btn-action { flex: 1; padding: 20px; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; color: white; }
        .btn-save { background: var(--primary-green); }
        .btn-cancel { background: var(--danger-red); }

        /* ICONA SPEGNIMENTO (CSS) */
        .icon-power::before { content: "‚èª"; }

        /* Stile per la griglia delle zone */
        .zona-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .zona-btn {
            padding: 15px 5px;
            border: 2px solid #ccc;
            border-radius: 10px;
            background: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Colore quando la zona √® selezionata */
        .zona-btn.selected {
            background-color: var(--primary-blue);
            color: white;
            border-color: #003d7a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .list-item {
            transition: background 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpg" alt="Logo" style="width:100px; margin-bottom:20px;" onerror="this.src='https://via.placeholder.com/100'">
        <div class="login-field"><label>UTENTE</label><input type="text" id="user" placeholder="Inserisci nome"></div>
        <div class="login-field"><label>PASSWORD</label><input type="password" id="pass" placeholder="********"></div>
        <div class="login-field">
            <label>ZONE</label>
            <div id="zona-grid-container" class="zona-grid"></div>
        </div>
        <button class="btn-big blue" onclick="handleLogin()" style="height:70px;">ENTRA</button>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header-bar">
            <div id="user-display" style="font-weight:bold;"></div>
            <button class="logout-btn" onclick="logout()" title="Esci">
                <span class="icon-power"></span>
            </button>
        </div>
        <div class="dashboard">
            <button class="btn-big blue" onclick="openNewDoc('CARICO')">DOCUMENTO CARICO</button>
            <button class="btn-big green" onclick="openNewDoc('DDT')">DDT (VENDITA)</button>
            <button class="btn-big yellow" onclick="showPage('page-modifica')">STAMPA / INVIO</button>
        </div>
    </div>

    <div id="page-editor" class="page hidden">
        <div id="editing-info" class="doc-info-bar">NUOVO DOCUMENTO</div>
        
        <div class="top-controls">
            <div class="top-half"><label>DATA</label><input type="date" id="doc-date-input"></div>
            <div class="top-half"><label>TARGA</label><select id="targa-select"></select></div>
        </div>

        <div id="cliente-area" class="cliente-box hidden">
            <label>CLIENTE (Cerca per nome o codice)</label>
            <div style="position: relative;">
                <input type="text" id="cliente-search" placeholder="Inizia a scrivere il nome..." 
                    oninput="cercaClienteLive()" autocomplete="off"
                    style="width:100%; padding:15px; font-size:18px; border:2px solid var(--primary-green); border-radius:10px;">
                <span onclick="resetCliente()" id="btn-reset-cliente" 
                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 25px; color: #999; cursor: pointer; display:none;">&times;</span>
            </div>
            <div id="clienti-suggeriti" style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ccc; border-radius: 0 0 10px 10px; display: none;"></div>
            
            <input type="hidden" id="selected-cliente-id">
        </div>

        <div style="padding:10px;position: relative;">
            <input type="text" id="art-search" placeholder="üîç Cerca articolo..." onkeyup="filterArticoli()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;">
            <span onclick="clearSearch()" style="position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #999; cursor: pointer; padding: 5px;">&times;</span>
        </div>
        
        <div id="articoli-list"></div>

        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')">ANNULLA</button>
            <button class="btn-action btn-save" onclick="salvaInLocale()">SALVA</button>
        </div>
    </div>

    <div id="page-modifica" class="page hidden">
        <div style="padding: 15px;">
            <h3 style="margin-top:0">Documenti in attesa</h3>
            <div id="lista-ddt-attesa"></div>
        </div>
        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')" style="width:100%">TORNA INDIETRO</button>
        </div>
    </div>

<script>
    // --- STATO DELL'APPLICAZIONE ---
    let anagraficaArticoli = []; 
    let anagraficheClienti = [];
    let targhe = [];
    let ddtSalvati = JSON.parse(localStorage.getItem('ddt_local') || '[]');
    let currentEditingId = null;
    let currentType = '';
    let zoneSelezionate = [];

    // --- CARICAMENTO INIZIALE ---
    window.onload = async () => {
        popolaZone();
        await caricaDatiBase();
        renderTarghe();
    };

    async function caricaDatiBase() {
        try {
            // Caricamento Articoli
            const resArt = await fetch('ANAPC00F_20260112 prodotti - Copia.csv');
            const textArt = await resArt.text();
            anagraficaArticoli = textArt.split('\n').slice(2).filter(r => r.includes('|')).map(row => {
                const c = row.split('|'); 
                return { id: c[0].trim(), um: c[1].trim(), nome: c[3].trim(), prezzoBase: parseFloat(c[6]) || 0 };
            });
            // Caricamento Targhe
            const resTar = await fetch('targhe.csv');
            targhe = (await resTar.text()).split('\n').map(t => t.trim()).filter(t => t);
        } catch (e) { console.error("Errore caricamento file base:", e); }
    }

    // --- GESTIONE LOGIN E ZONE ---
    function popolaZone() {
        const container = document.getElementById('zona-grid-container');
        const zoneList = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '22'];
        container.innerHTML = zoneList.map(z => `<div class="zona-btn" id="btn-zona-${z}" onclick="toggleZona('${z}')">${z}</div>`).join('');        
    }

    function toggleZona(z) {
        const btn = document.getElementById(`btn-zona-${z}`);
        const idx = zoneSelezionate.indexOf(z);
        if (idx > -1) { zoneSelezionate.splice(idx, 1); btn.classList.remove('selected'); }
        else { zoneSelezionate.push(z); btn.classList.add('selected'); }
    }

    async function handleLogin() {
        const u = document.getElementById('user').value;
        if(!u || zoneSelezionate.length === 0) return alert("Inserisci utente e seleziona almeno una zona");
        
        await caricaAnagraficheZone(zoneSelezionate);
        document.getElementById('user-display').innerText = `UTENTE: ${u.toUpperCase()} | ZONE: ${zoneSelezionate.sort().join(', ')}`;
        showPage('dashboard');
    }

    async function caricaAnagraficheZone(zoneArray) {
        anagraficheClienti = [];
        for (const zona of zoneArray) {
            try {
                const res = await fetch(`anagrafiche_${zona}.csv`);
                if (!res.ok) continue;
                const text = await res.text();
                const nuovi = text.split('\n').slice(1).filter(r => r.includes('|')).map(row => {
                    const c = row.split('|');
                    return { id: c[0].trim(), nome: c[3].trim(), zona: c[2].trim(), rg2: c[4]?.trim() || "" , localita: c[6]?.trim() || "" };
                });
                anagraficheClienti = anagraficheClienti.concat(nuovi);
            } catch (e) { console.error(`Errore zona ${zona}`, e); }
        }
    }

    // --- LOGICA CORE: RENDERING E FILTRI ---
    
    // Funzione UNICA per creare l'HTML di una riga articolo
    function creaRigaArticolo(art, qtaVal = 0, colliVal = 0, przVal = 0) {
        const qFmt = parseFloat(qtaVal || 0).toFixed(3);
        const pFmt = parseFloat(przVal || 0).toFixed(2);
        return `
            <div class="list-item" data-id="${art.id}" data-nome="${art.nome}">
                <div class="item-header"><strong>${art.id}</strong> ${art.nome}</div>
                <div class="input-row">
                    ${currentType === 'CARICO' ? `
                        <div class="qty-container"><label>COLLI</label><input type="number" class="large-input colli-in" value="${colliVal}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                        <div class="qty-container"><label>QUANTIT√Ä</label><input type="number" step="0.001" class="large-input qta-in" value="${qFmt}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                    ` : `
                        <div class="qty-container"><label>QUANTIT√Ä</label><input type="number" step="0.001" class="large-input qta-in" value="${qFmt}" onfocus="this.select()" oninput="pulisciErrore(this)"></div>
                        <div class="qty-container"><label>PREZZO ‚Ç¨</label><input type="number" step="0.01" class="large-input prz-in" value="${pFmt}" onfocus="this.select()"></div>
                    `}
                </div>
                <span class="error-msg" style="color:red; font-size:11px; font-weight:bold; display:block; margin-top:5px; height:15px;"></span>
            </div>`;
    }

    function renderArticoli(lista = anagraficaArticoli, isModifica = false) {
        const container = document.getElementById('articoli-list');
        if (!container) return;
        // In modifica mostriamo solo gli articoli passati, in nuovo documento usiamo la ricerca
        container.innerHTML = lista.map(art => {
            if(isModifica) return creaRigaArticolo(art, art.qta, art.colli, art.prezzo);
            return creaRigaArticolo(art, 0, 0, art.prezzoBase || 0);
        }).join('');
    }

    function filterArticoli() {
        const q = document.getElementById('art-search').value.toLowerCase();
        const container = document.getElementById('articoli-list');
        
        // 1. Gestione visibilit√† articoli gi√† presenti nel DOM
        let trovatiNelDom = false;
        document.querySelectorAll('#articoli-list .list-item').forEach(item => {
            const match = item.dataset.nome.toLowerCase().includes(q) || item.dataset.id.toLowerCase().includes(q);
            item.style.display = match ? 'flex' : 'none';
            if (match) trovatiNelDom = true;
        });

        // 2. Se stiamo cercando (almeno 2 caratteri) e non c'√® match nel DOM, cerchiamo in anagrafica
        if (q.length >= 2 && !trovatiNelDom) {
            const nuoviMatch = anagraficaArticoli.filter(a => 
                a.nome.toLowerCase().includes(q) || a.id.toLowerCase().includes(q)
            ).slice(0, 5); // Limitiamo a 5 risultati per performance

            nuoviMatch.forEach(art => {
                // Controlliamo che non sia gi√† stato aggiunto (per evitare duplicati)
                if (!document.querySelector(`#articoli-list .list-item[data-id="${art.id}"]`)) {
                    const nuovaRiga = creaRigaArticolo(art, 0, 0, art.prezzoBase || 0);
                    container.insertAdjacentHTML('beforeend', nuovaRiga);
                }
            });
        }
    }

    // --- GESTIONE DOCUMENTI ---
    function openNewDoc(type) {
        currentType = type;
        currentEditingId = null;
        document.getElementById('editing-info').innerText = "NUOVO: " + type;
        document.getElementById('doc-date-input').valueAsDate = new Date();
        
        document.getElementById('cliente-area').classList.toggle('hidden', type !== 'DDT');
        
        // Pulizia campi ricerca
        document.getElementById('art-search').value = '';
        resetCliente();
        
        showPage('page-editor');
        renderArticoli(); // Mostra l'intera anagrafica
    }

    function puliziaDocumentiVecchi() {
        const OGGI = new Date();
        const LIMITE_GIORNI = 3;
        let contatoreVecchi = 0;

        // Filtriamo i documenti
        const documentiFiltrati = ddtSalvati.filter(doc => {
            const dataDoc = new Date(doc.data);
            // Calcolo differenza in millisecondi e conversione in giorni
            const diffTempo = OGGI - dataDoc;
            const diffGiorni = diffTempo / (1000 * 60 * 60 * 24);

            if (diffGiorni > LIMITE_GIORNI) {
                contatoreVecchi++;
                return false; // Elimina il documento
            }
            return true; // Mantieni il documento
        });

        if (contatoreVecchi > 0) {
            // AVVISO TEMPORANEO (da togliere in produzione)
            alert(`‚ö†Ô∏è AVVISO DEBUG: Rilevati ${contatoreVecchi} documenti vecchi (pi√π di 3 giorni). Saranno eliminati.`);

            // Aggiorniamo lo stato e il localStorage
            ddtSalvati = documentiFiltrati;
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        }
    }

    function caricaPerModifica(id) {
        const doc = ddtSalvati.find(d => d.id === id);
        if (!doc) return;

        // CONTROLLO BLOCCO: Se stampato, impedisci la modifica
        if (doc.stampato) {
            alert("ATTENZIONE: Questo documento √® gi√† stato stampato e non pu√≤ pi√π essere modificato.");
            return;
        }

        currentEditingId = doc.id;
        currentType = doc.tipo;
        
        document.getElementById('art-search').value = '';
        showPage('page-editor');
        
        // ... resto del codice per caricare cliente e articoli ...
        renderArticoli(doc.items, true);
    }

    function salvaInLocale() {
        const idCli = document.getElementById('selected-cliente-id').value;
        if (currentType === 'DDT' && !idCli) return alert("Seleziona un cliente!");

        const items = [];
        let valid = true;

        document.querySelectorAll('#articoli-list .list-item').forEach(el => {
            const qta = parseFloat(el.querySelector('.qta-in')?.value) || 0;
            const colli = parseInt(el.querySelector('.colli-in')?.value) || 0;
            const prz = parseFloat(el.querySelector('.prz-in')?.value) || 0;
            const errorSpan = el.querySelector('.error-msg');

            if (currentType === 'CARICO' && ((qta > 0 && colli <= 0) || (colli > 0 && qta <= 0))) {
                el.style.background = "#ffe6e6";
                if(errorSpan) errorSpan.innerText = "‚ö†Ô∏è Inserire Qta e Colli";
                valid = false;
            }

            if (qta > 0 || colli > 0) {
                items.push({ id: el.dataset.id, nome: el.dataset.nome, qta, colli, prezzo: prz });
            }
        });

        if (!valid) return;
        if (items.length === 0) return alert("Inserisci almeno un articolo!");

        const doc = {
            id: currentEditingId || generaID(idCli),
            tipo: currentType,
            data: document.getElementById('doc-date-input').value,
            targa: document.getElementById('targa-select').value,
            clienteId: idCli || 'MAGAZZINO',
            clienteNome: currentType === 'DDT' ? document.getElementById('cliente-search').value.split(' - ')[1] : 'CARICO',
            zona: document.getElementById('selected-cliente-id').dataset.zona || '',
            items: items
        };

        const idx = ddtSalvati.findIndex(d => d.id === doc.id);
        if(idx > -1) ddtSalvati[idx] = doc; else ddtSalvati.push(doc);
        
        localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        localStorage.setItem('ultima_targa', doc.targa);
        showPage('dashboard');
    }

    function generaID(idCli) {
        const u = document.getElementById('user').value.substring(0,3).toUpperCase();
        const annoCorrente = new Date().getFullYear();
        
        // 1. Recuperiamo l'anno dell'ultimo documento creato
        const ultimoAnnoSalvato = localStorage.getItem('ultimo_anno_prog');
        
        // 2. Recuperiamo il progressivo attuale
        let prog = parseInt(localStorage.getItem('prog_doc') || '0');

        // 3. LOGICA DI RESET: Se l'anno √® diverso (o non esiste), ricomincia da 0
        if (ultimoAnnoSalvato !== annoCorrente.toString()) {
            prog = 0; 
            // Aggiorniamo subito l'anno di riferimento nel sistema
            localStorage.setItem('ultimo_anno_prog', annoCorrente.toString());
        }

        // 4. Incrementiamo e salviamo il nuovo valore
        prog++; 
        localStorage.setItem('prog_doc', prog);
        
        const pFmt = prog.toString().padStart(5, '0');
        const zona = document.getElementById('selected-cliente-id').dataset.zona || '00';

        // 5. Restituiamo l'ID finale
        if (currentType === 'DDT') {
            return `${u}-${annoCorrente}-${zona}-${idCli}-${pFmt}`;
        } else {
            return `${u}-${annoCorrente}-${pFmt}`;
        }
    }

    // --- INTERFACCIA UTENTE ---
    function showPage(id) {
        document.querySelectorAll('.page, #login-screen, #dashboard').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        // Trigger pulizia: Solo se entriamo nell'editor per un NUOVO CARICO
        if (id === 'page-editor' && currentType === 'CARICO' && currentEditingId === null) {
            puliziaDocumentiVecchi();
        }

        // Se stiamo entrando nell'editor, puliamo la barra di ricerca articoli
        if (id === 'page-editor') {
            const artSearch = document.getElementById('art-search');
            if (artSearch) artSearch.value = ''; 
            // Non chiamiamo filterArticoli qui perch√© l'elenco viene gi√† gestito da openNewDoc o caricaPerModifica
        }
        
        if (id === 'page-modifica') renderListaModifica();
    }

    function renderListaModifica() {
        const container = document.getElementById('lista-ddt-attesa');
        if (!container) return;

        container.innerHTML = ddtSalvati.map(d => {
            const tot = d.tipo === 'DDT' ? d.items.reduce((acc, i) => acc + (i.qta * i.prezzo), 0).toFixed(2) : null;
            
            // Stile condizionale: grigio se stampato, verde se modificabile
            const borderCol = d.stampato ? '#6c757d' : 'var(--primary-green)';
            const opacity = d.stampato ? '0.7' : '1';

            return `
                <div class="list-item" style="border-left:8px solid ${borderCol}; margin-bottom:10px; opacity: ${opacity}">
                    <div style="display:flex; justify-content:space-between">
                        <strong>${d.id}</strong> 
                        <span>${d.tipo} ${d.stampato ? '‚úÖ STAMPATO' : 'üìù BOZZA'}</span>
                    </div>
                    <div>Cod. ${d.clienteId} - <strong>${d.clienteNome}</strong></div>
                    <div style="font-size:12px">Articoli: ${d.items.length} ${tot ? `| <strong>Tot: ‚Ç¨ ${tot}</strong>` : ''}</div>
                    
                    <div style="display:flex; gap:10px; margin-top:10px">
                        ${!d.stampato ? `
                            <button onclick="caricaPerModifica('${d.id}')" style="flex:1; padding:10px">MODIFICA</button>
                        ` : `
                            <button disabled style="flex:1; padding:10px; background:#eee; color:#999; border:1px solid #ccc;">NON MODIFICABILE</button>
                        `}
                        <button onclick="stampaEInvia('${d.id}')" style="flex:1; padding:10px; background:var(--primary-yellow)">
                            ${d.stampato ? 'RISTAMPA' : 'STAMPA'}
                        </button>
                    </div>
                </div>`;
        }).join('');
    }

    function cercaClienteLive() {
        const q = document.getElementById('cliente-search').value.toLowerCase();
        const sug = document.getElementById('clienti-suggeriti');
        if (q.length < 2) return sug.style.display = 'none';

        const matches = anagraficheClienti.filter(a => a.nome.toLowerCase().includes(q) || a.id.includes(q)).slice(0, 10);
        sug.innerHTML = matches.map(a => `
            <div onclick="selezionaCliente('${a.id}', '${a.nome.replace(/'/g, "\\'")}', '${a.zona}')" style="padding:15px; border-bottom:1px solid #eee;">
                <strong>${a.id}</strong> - ${a.nome} <br><small>${a.rg2} - ${a.localita}</small>
            </div>`).join('');
        sug.style.display = matches.length ? 'block' : 'none';
    }

    function selezionaCliente(id, nome, zona) {
        const v = document.getElementById('cliente-search');
        const n = document.getElementById('selected-cliente-id');
        v.value = `${id} - ${nome}`; v.disabled = true;
        n.value = id; n.dataset.zona = zona;
        document.getElementById('clienti-suggeriti').style.display = 'none';
        document.getElementById('btn-reset-cliente').style.display = 'block';
    }

    function resetCliente() {
        const v = document.getElementById('cliente-search');
        v.value = ''; v.disabled = false;
        document.getElementById('selected-cliente-id').value = '';
        document.getElementById('btn-reset-cliente').style.display = 'none';
    }

    function pulisciErrore(el) {
        const r = el.closest('.list-item');
        r.style.background = "white";
        const m = r.querySelector('.error-msg');
        if(m) m.innerText = "";
    }

    function clearSearch() { document.getElementById('art-search').value = ''; filterArticoli(); }
    function renderTarghe() {
        const s = document.getElementById('targa-select');
        s.innerHTML = targhe.map(t => `<option value="${t}">${t}</option>`).join('');
        if(localStorage.getItem('ultima_targa')) s.value = localStorage.getItem('ultima_targa');
    }
    async function stampaEInvia(id) {
        //inviaDatiAlServer(); //da vedere quando inviare

        // Cerchiamo il documento nell'array
        const doc = ddtSalvati.find(d => d.id === id);
        if (!doc) return;

        // Simulazione invio stampa
        alert(`Documento ${id} inviato alla stampa!\nDa questo momento non sar√† pi√π modificabile.`);

        // Segniamo il documento come stampato
        doc.stampato = true;

        // Salviamo lo stato aggiornato
        localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
        
        // Torniamo alla dashboard o rinfreschiamo la lista
        renderListaModifica();
    }
    
    // Formatta Data in AAAAMMGG
    function formatDataCSV(dataISO) {
        return dataISO.replace(/-/g, '');
    }

    // Formatta Ora in HHMMSS
    function formatOraCSV() {
        const ora = new Date();
        return ora.getHours().toString().padStart(2, '0') +
            ora.getMinutes().toString().padStart(2, '0') +
            ora.getSeconds().toString().padStart(2, '0');
    }

    // Formatta i numeri con virgola e decimali fissi (es: 0,50000)
    function formatNumCSV(num, decimali) {
        return parseFloat(num).toFixed(decimali).replace('.', ',');
    }

    function preparaFilesPerServer() {
        let csvTestatina = "";
        let csvArticoli = "";

        // Filtriamo solo i DDT (escludiamo i Carichi)
        const soloDDT = ddtSalvati.filter(d => d.tipo === 'DDT');

        if (soloDDT.length === 0) {
            alert("Nessun DDT presente da inviare.");
            return null;
        }

        soloDDT.forEach(doc => {
            // --- LOGICA TESTATINA ---
            // Struttura: T|OC|serie|numero|codiceCliente|codiceCliente|data|ora
            
            const serie = "1";
            // Estraiamo il numero documento dall'ID (l'ultima parte dopo l'ultimo trattino)
            const numeroDoc = doc.id.split('-').pop(); 
            const dataFmt = formatDataCSV(doc.data);
            const oraFmt = formatOraCSV();
            
            // MODIFICA: Usiamo il codice cliente (es. 877) invece del nome
            const codiceCli = doc.clienteId; 

            // T | OC | serie | numero | destinatario1 | destinatario2 | data | ora
            csvTestatina += `T|OC|${serie}|${numeroDoc}|${codiceCli}|${codiceCli}|${dataFmt}|${oraFmt}\n`;

            // --- LOGICA ARTICOLI ---
            // Struttura: R|OC|data|serie|numero|codArt|qta|prezzo|0|0|UM|0
            doc.items.forEach(item => {
                // Cerchiamo l'UM nell'anagrafica caricata per quell'articolo
                const infoArt = anagraficaArticoli.find(a => a.id === item.id);
                const um = infoArt ? infoArt.um : 'KG';

                const riga = [
                    "R",
                    "OC",
                    dataFmt,
                    serie,
                    numeroDoc,
                    item.id,
                    formatNumCSV(item.qta, 5),
                    formatNumCSV(item.prezzo, 5),
                    um,
                ];
                csvArticoli += riga.join('|') + "|\n";
            });
        });

        return {
            testatina: csvTestatina,
            articoli: csvArticoli
        };
    }

    async function inviaDatiAlServer() {
        const files = preparaFilesPerServer();
        if (!files) return;

        // Messaggio di conferma con anteprima (Debug)
        console.log("File Testatina:\n", files.testatina);
        console.log("File Articoli:\n", files.articoli);

        const formData = new FormData();
        formData.append('testatina', new Blob([files.testatina], { type: 'text/csv' }), 'testatine.csv');
        formData.append('articoli', new Blob([files.articoli], { type: 'text/csv' }), 'articoli.csv');

        debugger;

        try {
            // Sostituiremo 'upload.php' con il tuo vero endpoint
            const response = await fetch('upload.php', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert("‚úÖ File inviati con successo al server!");
                // Qui potresti voler segnare i documenti come 'Inviati'
            } else {
                throw new Error("Errore durante l'invio");
            }
        } catch (error) {
            alert("‚ùå Errore di connessione: i file non sono stati inviati.");
            console.error(error);
        }
    }

    function logout() { if(confirm("Tornare al login?")) showPage('login-screen'); }

</script>
</body>
</html>