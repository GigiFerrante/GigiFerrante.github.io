<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schnitzer MVP - LogisticApp</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-blue: #0056b3;
            --primary-green: #28a745;
            --primary-yellow: #ffc107;
            --danger-red: #dc3545;
            --bg-light: #f4f7f6;
        }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg-light); touch-action: manipulation; }
        .hidden { display: none !important; }

        /* LOGIN */
        #login-screen { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        .login-field { width: 100%; margin-bottom: 20px; }
        .login-field label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .login-field input, .login-field select { width: 100%; padding: 18px; font-size: 20px; border: 2px solid #ccc; border-radius: 10px; }

        /* DASHBOARD & HEADER */
        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: #eee; border-bottom: 1px solid #ddd; 
        }
        .logout-btn { 
            background: var(--danger-red); border: none; border-radius: 50%; 
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dashboard { padding: 15px; }
        .btn-big { 
            width: 100%; height: 110px; border: none; border-radius: 15px; 
            font-size: 22px; font-weight: bold; color: white; margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-transform: uppercase;
        }
        .blue { background-color: var(--primary-blue); }
        .green { background-color: var(--primary-green); }
        .yellow { background-color: var(--primary-yellow); color: #333; }

        /* INFO BAR */
        .doc-info-bar { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; }

        /* HEADER 50/50 */
        .top-controls { display: flex; width: 100%; background: white; border-bottom: 2px solid #ccc; position: sticky; top: 0; z-index: 100; }
        .top-half { width: 50%; padding: 10px; border-right: 1px solid #eee; }
        .top-half label { font-size: 11px; font-weight: bold; display: block; color: #666; }
        .top-half input, .top-half select { width: 100%; font-size: 16px; padding: 10px 5px; border: 1px solid #aaa; border-radius: 5px; }

        /* LISTA ARTICOLI */
        .page { padding-bottom: 120px; }
        .list-item { background: white; padding: 15px 10px; border-bottom: 2px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .item-header { font-size: 17px; font-weight: bold; color: var(--primary-blue); }
        .input-row { display: flex; gap: 8px; }
        .qty-container { flex: 1; position: relative; }
        .qty-container label { font-size: 10px; color: #777; position: absolute; top: -7px; left: 8px; background: white; padding: 0 3px; z-index: 1; }
        .large-input { width: 100%; padding: 15px 5px; font-size: 20px; font-weight: 800; text-align: right; border: 2px solid #ccc; border-radius: 10px; }

        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.15); z-index: 1000; }
        .btn-action { flex: 1; padding: 20px; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; color: white; }
        .btn-save { background: var(--primary-green); }
        .btn-cancel { background: var(--danger-red); }

        /* ICONA SPEGNIMENTO (CSS) */
        .icon-power::before { content: "‚èª"; }

        /* Stile per la griglia delle zone */
        .zona-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .zona-btn {
            padding: 15px 5px;
            border: 2px solid #ccc;
            border-radius: 10px;
            background: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Colore quando la zona √® selezionata */
        .zona-btn.selected {
            background-color: var(--primary-blue);
            color: white;
            border-color: #003d7a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .list-item {
            transition: background 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpg" alt="Logo" style="width:100px; margin-bottom:20px;" onerror="this.src='https://via.placeholder.com/100'">
        <div class="login-field"><label>UTENTE</label><input type="text" id="user" placeholder="Inserisci nome"></div>
        <div class="login-field"><label>PASSWORD</label><input type="password" id="pass" placeholder="********"></div>
        <div class="login-field">
            <label>ZONE</label>
            <div id="zona-grid-container" class="zona-grid"></div>
        </div>
        <button class="btn-big blue" onclick="handleLogin()" style="height:70px;">ENTRA</button>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header-bar">
            <div id="user-display" style="font-weight:bold;"></div>
            <button class="logout-btn" onclick="logout()" title="Esci">
                <span class="icon-power"></span>
            </button>
        </div>
        <div class="dashboard">
            <button class="btn-big blue" onclick="openNewDoc('CARICO')">DOCUMENTO CARICO</button>
            <button class="btn-big green" onclick="openNewDoc('DDT')">DDT (VENDITA)</button>
            <button class="btn-big yellow" onclick="showPage('page-modifica')">STAMPA / INVIO</button>
        </div>
    </div>

    <div id="page-editor" class="page hidden">
        <div id="editing-info" class="doc-info-bar">NUOVO DOCUMENTO</div>
        
        <div class="top-controls">
            <div class="top-half"><label>DATA</label><input type="date" id="doc-date-input"></div>
            <div class="top-half"><label>TARGA</label><select id="targa-select"></select></div>
        </div>

        <div id="cliente-area" class="cliente-box hidden">
            <label>CLIENTE (Cerca per nome o codice)</label>
            <div style="position: relative;">
                <input type="text" id="cliente-search" placeholder="Inizia a scrivere il nome..." 
                    oninput="cercaClienteLive()" autocomplete="off"
                    style="width:100%; padding:15px; font-size:18px; border:2px solid var(--primary-green); border-radius:10px;">
                <span onclick="resetCliente()" id="btn-reset-cliente" 
                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 25px; color: #999; cursor: pointer; display:none;">&times;</span>
            </div>
            <div id="clienti-suggeriti" style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ccc; border-radius: 0 0 10px 10px; display: none;"></div>
            
            <input type="hidden" id="selected-cliente-id">
        </div>

        <div style="padding:10px;position: relative;">
            <input type="text" id="art-search" placeholder="üîç Cerca articolo..." onkeyup="filterArticoli()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;">
            <span onclick="clearSearch()" style="position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #999; cursor: pointer; padding: 5px;">&times;</span>
        </div>
        
        <div id="articoli-list"></div>

        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')">ANNULLA</button>
            <button class="btn-action btn-save" onclick="salvaInLocale()">SALVA</button>
        </div>
    </div>

    <div id="page-modifica" class="page hidden">
        <div style="padding: 15px;">
            <h3 style="margin-top:0">Documenti in attesa</h3>
            <div id="lista-ddt-attesa"></div>
        </div>
        <div class="bottom-bar">
            <button class="btn-action btn-cancel" onclick="showPage('dashboard')" style="width:100%">TORNA INDIETRO</button>
        </div>
    </div>

    <script>
        let articoli = [];
        let anagrafiche = [];
        let targhe = [];
        let ddtSalvati = JSON.parse(localStorage.getItem('ddt_local') || '[]');
        let currentEditingId = null;
        let currentType = '';
        let userZona = '00';
        let zoneSelezionate = []; // Array per memorizzare le scelte delle zone
        let clienteSelezionato = null;

        window.onload = async () => {
            popolaZone();
            await caricaCSVBase();
            renderTarghe();
        };

        function logout() {
            if(confirm("Vuoi tornare alla pagina di login?")) {
                showPage('login-screen');
            }
        }

        function popolaZone() {
            const container = document.getElementById('zona-grid-container');
                const zoneList = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '22'];
                
                container.innerHTML = zoneList.map(z => `
                    <div class="zona-btn" id="btn-zona-${z}" onclick="toggleZona('${z}')">
                        ${z}
                    </div>
                `).join('');        
        }

        function toggleZona(z) {
            const btn = document.getElementById(`btn-zona-${z}`);
            const index = zoneSelezionate.indexOf(z);

            if (index > -1) {
                // Se gi√† selezionata, la rimuovo
                zoneSelezionate.splice(index, 1);
                btn.classList.remove('selected');
            } else {
                // Altrimenti la aggiungo
                zoneSelezionate.push(z);
                btn.classList.add('selected');
            }
        }

        // MODIFICA: Gestione Login Multi-Zona
        async function handleLogin() {
            const u = document.getElementById('user').value;

            if(!u) return alert("Inserisci nome utente");
            if(zoneSelezionate.length === 0) return alert("Seleziona almeno una zona");

            // Mostra un messaggio di caricamento (opzionale)
            document.getElementById('user-display').innerText = "Caricamento anagrafiche...";

            // Carica dinamicamente i file CSV delle zone selezionate
            await caricaAnagraficheZone(zoneSelezionate);

            zoneSelezionate.sort();
            userZona = zoneSelezionate.join(', '); 

            document.getElementById('user-display').innerText = `UTENTE: ${u.toUpperCase()} | ZONE: ${userZona}`;
            showPage('dashboard');
        }

        function cercaClienteLive() {
            const query = document.getElementById('cliente-search').value.toLowerCase();
            const suggeriti = document.getElementById('clienti-suggeriti');
            
            if (query.length < 2) {
                suggeriti.style.display = 'none';
                return;
            }

            // Filtra anagrafiche per nome o ID
            const matches = anagrafiche.filter(a => 
                a.nome.toLowerCase().includes(query) || a.id.includes(query)
            ).slice(0, 10); // Mostra solo i primi 10 per velocit√†

            if (matches.length > 0) {
                // Nella funzione cercaClienteLive
                suggeriti.innerHTML = matches.map(a => `
                    <div onclick="selezionaCliente('${a.id}', '${a.nome.replace(/'/g, "\\'")}', '${a.zonaVera}')" 
                        style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;">
                        <div style="font-weight: bold; color: var(--primary-blue);">${a.id} - ${a.nome}</div>
                        <div style="font-size: 13px; color: #666;">
                            Loc: <strong>${a.localita}</strong> | Zona: ${a.zonaVera}
                        </div>
                    </div>
                `).join('');
                suggeriti.style.display = 'block';
            } else {
                suggeriti.style.display = 'none';
            }
        }

        function selezionaCliente(id, nome, zona) {
            const inputVisuale = document.getElementById('cliente-search');
            const inputNascosto = document.getElementById('selected-cliente-id');
            
            inputVisuale.value = `${id} - ${nome}`;
            inputVisuale.disabled = true;
            
            inputNascosto.value = id;
            inputNascosto.dataset.zona = zona; // <--- Qui salviamo il terzo campo
            
            document.getElementById('clienti-suggeriti').style.display = 'none';
            document.getElementById('btn-reset-cliente').style.display = 'block';
        }

        function resetCliente() {
            if(currentEditingId) return; // Impedisce il reset se siamo in modalit√† modifica
            clienteSelezionato = null;
            const input = document.getElementById('cliente-search');
            input.value = '';
            input.disabled = false;
            input.style.background = "white";
            document.getElementById('selected-cliente-id').value = '';
            document.getElementById('btn-reset-cliente').style.display = 'none';
            input.focus();
        }

        async function caricaCSVBase() {
            try {
                const resArt = await fetch('ANAPC00F_20260112 prodotti - Copia.csv');
                articoli = (await resArt.text()).split('\n').slice(2).filter(r => r.includes('|')).map(row => {
                    const c = row.split('|'); return { id: c[0], um: c[1], nome: c[3], prezzo: c[6] };
                });
                const resTar = await fetch('targhe.csv');
                targhe = (await resTar.text()).split('\n').map(t => t.trim()).filter(t => t);
            } catch (e) { console.error("Errore caricamento file base"); }
        }

        async function caricaAnagraficheZone(zoneArray) {
            anagrafiche = []; // Reset lista anagrafiche
            
            for (const zona of zoneArray) {
                try {
                    const fileName = `anagrafiche_${zona}.csv`;
                    const response = await fetch(fileName);
                    if (!response.ok) {
                        console.warn(`File non trovato: ${fileName}`);
                        continue;
                    }
                    const text = await response.text();
                    const righe = text.split('\n').slice(1); // Salta la prima riga (intestazione)
                                        
                    // Nella funzione caricaAnagraficheZone, modifica il mapping:
                    const nuoviClienti = righe.filter(r => r.includes('|')).map(row => {
                        const c = row.split('|');
                        return { 
                            id: c[0].trim(), 
                            nome: c[3].trim(), 
                            zonaVera: c[2].trim(),// Terzo campo
                            localita: c[4] ? c[4].trim() : "" // <--- Quinto campo (LOCCL)
                        };
                    });
                    
                    anagrafiche = anagrafiche.concat(nuoviClienti);
                } catch (e) {
                    console.error(`Errore nel caricamento della zona ${zona}:`, e);
                }
            }
            console.log(`Caricate ${anagrafiche.length} anagrafiche per le zone: ${zoneArray.join(', ')}`);
        }
        function renderTarghe() {
            const s = document.getElementById('targa-select');
            s.innerHTML = targhe.map(t => `<option value="${t}">${t}</option>`).join('');
            if(localStorage.getItem('ultima_targa')) s.value = localStorage.getItem('ultima_targa');
        }

        function showPage(id) {
            document.querySelectorAll('.page, #login-screen, #dashboard').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
            // MODIFICA: Pulizia ricerca al cambio pagina
            if(id === 'page-editor') {
                document.getElementById('art-search').value = '';
                filterArticoli();
            }
            if(id === 'page-modifica') renderListaModifica();
        }

        function generaNumeroDocumento(prefix, zona, clienteId) {
            let prog = parseInt(localStorage.getItem('prog_doc') || '0') + 1;
            localStorage.setItem('prog_doc', prog);
            
            const progressivoFmt = prog.toString().padStart(5, '0');

            if (currentType === 'DDT') {
                // Formato DDT: UTE - ZONA - IDCLIENTE - PROG
                return `${prefix}-${zona}-${clienteId}-${progressivoFmt}`;
            } else {
                // Formato CARICO: UTE - PROG
                return `${prefix}-${progressivoFmt}`;
            }
        }

        function openNewDoc(type) {
            currentType = type;
            currentEditingId = null;
            document.getElementById('editing-info').innerText = "NUOVO: " + type;
            document.getElementById('doc-date-input').valueAsDate = new Date();
            
            // Gestione Area Cliente
            const areaCliente = document.getElementById('cliente-area');
            if (type === 'DDT') {
                areaCliente.classList.remove('hidden');
                resetCliente(); // Usa la funzione di reset che abbiamo creato
            } else {
                areaCliente.classList.add('hidden');
            }

            // Reset ricerca articoli
            document.getElementById('art-search').value = '';
            
            showPage('page-editor');
            renderArticoli();
        }

        function renderArticoli(datiPreesistenti = null) {
            const container = document.getElementById('articoli-list');
            container.innerHTML = articoli.map(art => {
                let qtaVal = "", colliVal = "", przVal = parseFloat(art.prezzo || 0).toFixed(2);
                
                if(datiPreesistenti) {
                    const trovato = datiPreesistenti.find(r => r.id === art.id);
                    if(trovato) {
                        qtaVal = trovato.qta;
                        colliVal = trovato.colli || "";
                        przVal = trovato.prezzo;
                    }
                }

                return `
                <div class="list-item" data-id="${art.id}" data-nome="${art.nome}">
                    <div class="item-header">${art.id} ${art.nome}</div>
                    <div class="input-row">
                        ${currentType === 'CARICO' ? `
                            <div class="qty-container">
                                <label>COLLI</label>
                                <input type="number" class="large-input colli-in" value="${colliVal}" onfocus="this.select()" oninput="pulisciErrore(this)">
                            </div>
                            <div class="qty-container">
                                <label>QUANTIT√Ä ${art.um}</label>
                                <input type="number" step="0.001" class="large-input qta-in" value="${parseFloat(qtaVal || 0).toFixed(3)}" onfocus="this.select()" oninput="pulisciErrore(this)">
                            </div>
                        ` : `
                            <div class="qty-container">
                                <label>QUANTIT√Ä ${art.um}</label>
                                <input type="number" step="0.001" class="large-input qta-in" value="${parseFloat(qtaVal || 0).toFixed(3)}" onfocus="this.select()" oninput="pulisciErrore(this)">
                            </div>
                            <div class="qty-container">
                                <label>PREZZO ‚Ç¨</label>
                                <input type="number" step="0.01" class="large-input prz-in" value="${parseFloat(przVal || 0).toFixed(2)}">
                            </div>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        function pulisciErrore(inputElement) {
            // Risale fino al div della riga (list-item) e resetta il colore
            const riga = inputElement.closest('.list-item');
            if (riga) {
                riga.style.background = "white"; 
            }
        }

        function salvaInLocale() {
            document.querySelectorAll('.list-item').forEach(el => el.style.background = "white");

            // 1. Recuperiamo l'ID del cliente dal campo nascosto
            const campoNascosto = document.getElementById('selected-cliente-id');
            const idCli = campoNascosto.value;
            const zonaDati = campoNascosto.dataset.zona; // Recupera il valore salvato sopra
    
            // 2. Controllo obbligatoriet√† per DDT
            if(currentType === 'DDT' && !idCli) return alert("ERRORE: Seleziona un cliente!");

            const items = [];
            document.querySelectorAll('.list-item').forEach(el => {

                const qtaInput = parseFloat(el.querySelector('.qta-in').value) || 0;
                const prezzo = parseFloat(el.querySelector('.prz-in').value) || 0;

                const colliInput = el.querySelector('.colli-in');
                
                const qta = qtaInput ? qtaInput.value : "";
                const colli = colliInput ? colliInput.value : "";
                const nomeArt = el.dataset.nome;
                erroreValidazione = false;

                // MODIFICA: Logica obbligatoriet√† incrociata per CARICO
                if (currentType === 'CARICO') {
                    // Se uno dei due √® pieno e l'altro √® vuoto (o zero)
                    if ((qta > 0 && (!colli || colli <= 0)) || (colli > 0 && (!qta || qta <= 0))) {
                        alert(`ERRORE su "${nomeArt}":\nSe inserisci i Colli devi inserire la Quantit√† (e viceversa).`);
                        erroreValidazione = true;
                        el.style.background = "#ffe6e6"; // Evidenzia la riga con errore
                        return;
                    }
                }

                // Se entrambi sono compilati correttamente, aggiungi all'array
                if (qta > 0) {
                    items.push({
                        id: el.dataset.id,
                        nome: nomeArt,
                        qta: parseFloat(qta.toFixed(3)),
                        colli: parseInt(colli) || 0,
                        prezzo: currentType === 'DDT' ? parseFloat(prezzo.toFixed(2)) : 0
                    });
                }
                
            });

            if (erroreValidazione) return; // Blocca il salvataggio se c'√® un errore
            if (items.length === 0) return alert("Inserisci almeno un articolo!");

            if(items.length === 0) return alert("Inserisci almeno un articolo!");

            let docId = currentEditingId;
            if(!docId) {
                const nomeUtente = document.getElementById('user').value || "XXX";
                const prefix = nomeUtente.substring(0, 3).toUpperCase();

                if (currentType === 'DDT') {
                    const nomeUtente = document.getElementById('user').value || "XXX";
                    const prefix = nomeUtente.substring(0, 3).toUpperCase();
                    
                    // Ora zonaDati contiene il terzo campo del CSV
                    docId = generaNumeroDocumento(prefix, zonaDati, idCli);
                } else {
                    docId = generaNumeroDocumento(prefix);
                }
            }

            const doc = {
                id: docId,
                tipo: currentType,
                data: document.getElementById('doc-date-input').value,
                targa: document.getElementById('targa-select').value,
                clienteId: idCli || 'MAGAZZINO',
                clienteNome: currentType === 'DDT' ? document.getElementById('cliente-search').value.split(' - ')[1] : 'CARICO',
                items: items
            };

            const idx = ddtSalvati.findIndex(d => d.id === docId);
            if(idx > -1) ddtSalvati[idx] = doc; else ddtSalvati.push(doc);
            
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
            showPage('dashboard');
        }

        function renderListaModifica() {
            const c = document.getElementById('lista-ddt-attesa');
            
            c.innerHTML = ddtSalvati.map(d => {
                // MODIFICA: Formattazione data da YYYY-MM-DD a DD/MM/YYYY
                const dataParti = d.data.split('-'); 
                const dataIta = `${dataParti[2]}/${dataParti[1]}/${dataParti[0]}`;

                return `
                    <div style="background:white; padding:15px; margin-bottom:10px; border-radius:10px; border-left:8px solid var(--primary-green)">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <strong>${d.id}</strong>
                            <span style="font-size:12px; background:#eee; padding:2px 5px; border-radius:4px;">${d.tipo}</span>
                        </div>
                        <div style="margin: 5px 0; color: #555;">
                            ${d.clienteNome}<br>
                            <small>Data: <strong>${dataIta}</strong> | Targa: ${d.targa}</small>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="caricaPerModifica('${d.id}')" style="flex:1; padding:12px; background:#f8f9fa; border:1px solid #ccc; border-radius:8px; font-weight:bold;">MODIFICA</button>
                            <button onclick="stampaEInvia('${d.id}')" style="flex:1; padding:12px; background:var(--primary-yellow); border:none; border-radius:8px; font-weight:bold;">STAMPA</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function caricaPerModifica(id) {
            const doc = ddtSalvati.find(d => d.id === id);
            currentEditingId = id;
            currentType = doc.tipo;
            
            showPage('page-editor');
            document.getElementById('editing-info').innerText = "MODIFICA: " + id;
            document.getElementById('doc-date-input').value = doc.data;
            document.getElementById('targa-select').value = doc.targa;
            
            const areaCliente = document.getElementById('cliente-area');
            if (doc.tipo === 'DDT') {
                areaCliente.classList.remove('hidden');
                
                // Popola i nuovi campi di ricerca cliente
                const input = document.getElementById('cliente-search');
                input.value = `${doc.clienteId} - ${doc.clienteNome}`;
                input.disabled = true; // Blocca modifica
                input.style.background = "#e9f5ec";
                
                document.getElementById('selected-cliente-id').value = doc.clienteId;
                document.getElementById('btn-reset-cliente').style.display = 'none'; // Nascondi X in modifica
            } else {
                areaCliente.classList.add('hidden');
            }

            // Reset ricerca articoli
            document.getElementById('art-search').value = '';
            renderArticoli(doc.items);
        }

        async function stampaEInvia(id) {
            alert("Stampato!");
            ddtSalvati = ddtSalvati.filter(d => d.id !== id);
            localStorage.setItem('ddt_local', JSON.stringify(ddtSalvati));
            renderListaModifica();
        }

        function renderAnagrafiche() {
            const s = document.getElementById('cliente-select');
            s.innerHTML = '<option value="">-- SELEZIONA UN CLIENTE --</option>' + 
                          anagrafiche.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
        }

        function filterArticoli() {
            const q = document.getElementById('art-search').value.toLowerCase();
            document.querySelectorAll('.list-item').forEach(item => {
                item.style.display = item.dataset.nome.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        }

        function clearSearch() {
            const searchInput = document.getElementById('art-search');
            searchInput.value = '';
            searchInput.focus(); // Riporta il focus per scrivere subito
            filterArticoli();    // Mostra di nuovo tutti gli articoli
        }

        function filterAnagrafiche() {
            const query = document.getElementById('ana-search').value.toLowerCase();
            const select = document.getElementById('cliente-select');
            const options = select.options;
            let firstFound = false;

            for (let i = 1; i < options.length; i++) { // Parte da 1 per saltare l'opzione vuota
                const text = options[i].text.toLowerCase();
                const match = text.includes(query);
                options[i].style.display = match ? 'block' : 'none';
                if (match && !firstFound) {
                    select.value = options[i].value; // Seleziona automaticamente il primo risultato
                    firstFound = true;
                }
            }
        }

        function clearAnaSearch() {
            document.getElementById('ana-search').value = '';
            const options = document.getElementById('cliente-select').options;
            for (let i = 0; i < options.length; i++) options[i].style.display = 'block';
            document.getElementById('cliente-select').value = "";
        }
    </script>
</body>
</html>